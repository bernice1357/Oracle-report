<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>INDEX</title>

    <!-- JSON -->
    <script type="text/javascript" src="./function/import/table.json"></script>
    <script type="text/javascript" src="./json/structure.json"></script>
    <script type="text/javascript" src="./json/component.json"></script>
    <script type="text/javascript" src="./json/table_name.json"></script>
    <!-- JQUERY -->
    <script src="./scripts/jquery-3.5.1.min.js"></script>
    <!-- CSS --> 
    <link rel="stylesheet" href="./assets/css/style.css" media="screen"/>
    <link rel="stylesheet" href="./assets/css/print.css" media="print"/>

</head>
<body>
    <div id="btnBlock">
        <button class="save hide" onclick="save()">結束編輯</button>
        <button class="edit" onclick="edit()">編輯</button>
        <button class="download" onclick="download()">儲存</button>
    </div>
    <div id="page_block">
        <center style="display:block;">頁面修改操作按鈕</center>
        <button id="deleteCurrent"><img name="title" width="50" src="./assets/svg/delete.svg"></img></button>
        <button id="addPrevious"><img name="title" width="50" src="./assets/svg/up.svg"></img></button>
        <button id="addAfter"><img name="title" width="50" src="./assets/svg/down.svg"></img></button>
    </div>
    <div id="component_block">
        <center style="display:block;">拖曳元件至頁面上
            <button name="title" draggable="true"><img name="title" width="50" src="./assets/svg/title.svg"></img></button>
            <button name="content" draggable="true"><img name="text" width="50" src="./assets/svg/text.svg"></img></button>
            <button name="image" draggable="true"><img name="image" width="50" src="./assets/svg/image.svg"></img></button>
            <button name="table" draggable="true"><img name="table" width="50" src="./assets/svg/table.svg"></img></button>
            <button name="list" draggable="true"><img name="list" width="50" src="./assets/svg/list.svg"></img></button>
        </center>
    </div>
    <div id="styleBoard" class="hide">
        <input type="color" id="font-color"/>
        <select id="font-size">
            <option>8</option>
            <option>9</option>
            <option>10</option>
            <option>11</option>
            <option>12</option>
            <option>14</option>
            <option>18</option>
            <option>24</option>
            <option>30</option>
            <option>36</option>
            <option>48</option>
            <option>60</option>
            <option>72</option>
            <option>96</option>
        </select>
        <br>
        <button><img width="50" id="align-left" src="assets/svg/align-left.svg"></img></button>
        <button><img width="50" id="align-center" src="assets/svg/align-center.svg"></img></button>
        <button><img width="50" id="align-right" src="assets/svg/align-right.svg"></img></button>
        <br>
        <button><img width="50" id="italic" src="assets/svg/italic.svg"></img></button>
        <button><img width="50" id="bold" src="assets/svg/bold.svg"></img></button>
        <br>
        <button><img width="50" id="list-circle" src="assets/svg/list-circle.svg"></img></button>
        <button><img width="50" id="list-number" src="assets/svg/list-number.svg"></img></button>
        <button><img width="50" id="list-square" src="assets/svg/list-square.svg"></img></button>
    </div>
</body>
<script>
    var currentPageId, currentPage, currentText;
    //亂數
    function Random(){
        return Math.random().toString(36).substring(8,11);
    }

    //調整頁面高度
    function pageResize() {
        var pages = document.querySelectorAll('.page');
        for(var i=0; i<pages.length; i++){
            if(pages[i].scrollHeight <= 1489 || !pages[i].scrollHeight){

                pages[i].style.height = '1485px';
            }else{
                pages[i].style.height = 'auto';
            }
        }
    }

    //clear listeners
    function clearListeners(className){
        var el = document.querySelectorAll(className);
        for(var i=0; i<el.length; i++){
            elClone = el[i].cloneNode(true);
            el[i].parentNode.replaceChild(elClone, el[i]);
        }
    }

    //註冊 page listenersclearListeners
    function pageRegister(){
        var pages = document.getElementsByClassName('page');
        
        for(var i=0; i<pages.length; i++){
        
            pages[i].onclick = function(e){

                //clear current page
                for(var i=0; i<pages.length; i++){
                    pages[i].classList.remove('currentPage');
                    currentPage = '';
                }

                //get which page is clicked
                currentPageId = e.target.closest('.page');

                if(currentPageId.id.includes('page')){
                    currentPage = document.getElementById(String(currentPageId.id));
                    currentPage.classList.add('currentPage');
                }
            }
        }
    }

    //add img listeners
    function imgListener(){

        clearListeners('.img-border');
        var uploaders = document.querySelectorAll('.img-border');

        for(var i=0; i<uploaders.length; i++){
            uploaders[i].children[0].classList.remove('hide');
            uploaders[i].children[0].addEventListener('click', async function(e){
                let fileHandle;
                const pickerOpts = {
                    types: [
                        {
                            description: 'Images',
                            accept: {
                                'image/*': ['.png', '.jpeg', '.jpg']
                            }
                        },
                    ],
                    excludeAcceptAllOption: true,
                    multiple: false
                };

                //使用者透過 FilePicker 選取檔案
                var target = e.target.parentNode.children[2];
                fileHandle = await window.showOpenFilePicker(pickerOpts);
                var file = await fileHandle[0].getFile();
                target.src = './assets/images/'+file.name;

                //如果是新元件要上傳圖片
                if(target.className.includes('hide')){
                    e.target.parentNode.children[1].classList.add('hide');
                    target.classList.remove('hide');
                }
            });
        }
    }

    window.addEventListener("load", function(event) {
        pageRegister();
    });


    function createTitle(content, style){
        var newEl = document.createElement('p');
        newEl.classList.add('title');

        if(style.length){
            newEl.style.color = style[0];
            newEl.style.fontSize = style[1];
            newEl.style.textAlign = style[2];
            newEl.style.fontStyle = style[3];
            newEl.style.fontWeight = style[4];
        }
        
        newEl.innerHTML = content;
        return newEl;
    }

    function createContent(content, style){
        var newEl = document.createElement('p');
        newEl.classList.add('content');

        if(style.length){
            newEl.style.color = style[0];
            newEl.style.fontSize = style[1];
            newEl.style.textAlign = style[2];
            newEl.style.fontStyle = style[3];
            newEl.style.fontWeight = style[4];
        }

        //加入content
        newEl.innerHTML = content;
        return newEl;
    }

    function createTable(tableName, editable){

        //建立div
        var newEl = document.createElement('div');
        newEl.className = 'table-border';
        newEl.setAttribute("name", tableName);

        //加入table資料
        if(!tableName){//new
            newEl.innerHTML = component['table'];
        }else{//modified
            var modified = tableName.replace(/ /g,'_');
            newEl.innerHTML = tableContent[modified];
        } 

        //新增select和選項
        var select = document.createElement('select');
        for(var item in table_name.tables){
            
            var option = document.createElement('option');

            if(tableName === table_name.tables[item].name){
                option.setAttribute('selected', true);
            }
            option.innerHTML = table_name.tables[item].name;
            select.appendChild(option);
        }

        if(!editable) select.classList.add('hide');
        newEl.insertBefore(select, newEl.children[0]);

        return newEl;
    }

    function createImg(path){

        //建立div
        var newEl = document.createElement('div');
        newEl.className = 'img-border';
        newEl.innerHTML = component['img'];

        //決定哪些要顯示
        if(!path){
            newEl.children[2].classList.add('hide');
        }else{
            newEl.children[1].classList.add('hide');
            newEl.children[2].src = path;
        }
        newEl.children[0].classList.add('hide');

        return newEl;
    }
    
    function createList(content, style){
        
        var newEl = document.createElement('ol');
        newEl.classList.add('list');

        for(var i in content){
            var li = document.createElement('li');
            li.innerHTML = content[i];
            newEl.appendChild(li);
        }

        if(style.length){
            newEl.style.color = style[0];
            newEl.style.fontSize = style[1];
            newEl.style.textAlign = style[2];
            newEl.style.fontStyle = style[3];
            newEl.style.fontWeight = style[4];
        }

        return newEl;
    }

    function createInput(content, style){

        var newEl = document.createElement('input');
        newEl.value = content.innerHTML;
        newEl.classList.add('text');
        newEl.classList.add('title');
        if(newEl.id) newEl.id = content.id;

        if(style.length){
            newEl.style.color = style[0];
            newEl.style.fontSize = style[1];
            newEl.style.textAlign = style[2];
            newEl.style.fontStyle = style[3];
            newEl.style.fontWeight = style[4];
        }
        return newEl;
    }

    function createTextarea(content, style, type){

        var newEl = document.createElement('textarea');

        if(type=='list'){

            newEl.value = content;
            newEl.classList.add('list');

        }else if(type=='content'){

            newEl.value = content.innerHTML;
            newEl.classList.add('content');
        }
        newEl.classList.add('text');
        if(newEl.id) newEl.id = content.id;

        if(style.length){
            newEl.style.color = style[0];
            newEl.style.fontSize = style[1];
            newEl.style.textAlign = style[2];
            newEl.style.fontStyle = style[3];
            newEl.style.fontWeight = style[4];
        }
        return newEl;
    }
</script>
<script src="./function/import/import.js"></script>
<script src="./js/pageHeight.js"></script>
<script src="./function/edit/edit.js"></script>
<script src="./function/save/save.js"></script>
<script src="./function/add/addComponent.js"></script>
<script src="./function/add/addPage.js"></script>
<script src="./function/export/export.js"></script>
</html>